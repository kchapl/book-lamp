<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Book Lamp{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    {% block head %}{% endblock %}
</head>

<body>
    <nav>
        <a href="/" class="logo">Book Lamp</a>
        <div class="nav-links" style="display: flex; align-items: center; gap: 1rem;">
            <a href="/books">Books</a>
            <a href="/history">History</a>
            <a href="/stats">Stats</a>
            <a href="/about">About</a>
            {% if not is_authorised %}
            <a href="/connect" class="btn" style="padding: 0.4rem 1rem; font-size: 0.8rem;">Authorise</a>
            {% endif %}

            <span id="connection-status" class="status-dot {{ 'connected' if is_authorised else 'disconnected' }}"
                title="{{ 'Google Sheets Connected (Click to Disconnect)' if is_authorised else 'Google Sheets Not Connected (Click to Authorise)' }}"
                data-authorised="{{ 'true' if is_authorised else 'false' }}" style="margin-left: 0.5rem;"
                onclick="toggleConnection()"></span>
        </div>
    </nav>

    <!-- Background Job Progress Indicator -->
    <div id="job-indicator" style="display: none; position: relative; width: 100%; margin: 0; padding: 0;">
        <!-- Subtle progress bar -->
        <div id="job-progress-bar"
            style="width: 100%; height: 3px; background-color: rgba(59, 130, 246, 0.1); overflow: hidden; position: relative;">
            <div id="job-progress-fill"
                style="height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); width: 0%; transition: width 0.3s ease; box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);">
            </div>
        </div>
        <!-- Status message below progress bar -->
        <div
            style="padding: 0.75rem 1.5rem; background: rgba(59, 130, 246, 0.05); border-bottom: 1px solid rgba(59, 130, 246, 0.1); display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
            <span
                style="display: inline-block; width: 6px; height: 6px; background: #3b82f6; border-radius: 50%; animation: pulse 2s infinite;"></span>
            <span id="job-status-text">Processing...</span>
        </div>
    </div>

    <style>
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>

    <div class="container" style="padding-top: 1rem;">
        <div class="messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert {{ category }}">
                {% if category == 'success' %}
                <span>✨</span>
                {% elif category == 'error' %}
                <span>⚠️</span>
                {% elif category == 'info' %}
                <span>ℹ️</span>
                {% endif %}
                <span>{{ message }}</span>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        {% block content %}{% endblock %}
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Confirm Delete</h2>
            <p id="modal-message">Are you sure you want to delete this?</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="btn">Confirm</button>
                <button onclick="closeModal()" class="btn btn-outline">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');

            // Remove old listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                closeModal();
            });

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('confirm-modal');
            if (event.target == modal) {
                closeModal();
            }
        }

        function submitPostRequest(urlStr) {
            try {
                var url = new URL(urlStr, window.location.origin);
                if ((url.protocol === 'http:' || url.protocol === 'https:') &&
                    url.origin === window.location.origin) {
                    var f = document.createElement('form');
                    f.method = 'POST';
                    f.action = url.toString();
                    document.body.appendChild(f);
                    f.submit();
                }
            } catch (e) {
                console.error('Failed to submit request:', e);
            }
        }

        function toggleConnection() {
            const statusDot = document.getElementById('connection-status');
            const isAuthorised = statusDot.getAttribute('data-authorised') === 'true';
            if (isAuthorised) {
                showConfirm(
                    'Disconnect Google Sheets',
                    'Are you sure you want to disconnect? You will need to re-authorise to access your data.',
                    () => { window.location.href = '/logout'; }
                );
            } else {
                showConfirm(
                    'Authorise Google Sheets',
                    'Would you like to authorise Google Sheets to store your reading data?',
                    () => { window.location.href = '/connect'; }
                );
            }
        }
    </script>
    <script src="{{ url_for('static', filename='button-feedback.js') }}" defer></script>
    <script src="{{ url_for('static', filename='job-monitor.js') }}" defer></script>
    <script>
        // Auto-hide alert messages after 10 seconds
        document.addEventListener('DOMContentLoaded', function () {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function (alert) {
                setTimeout(function () {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    alert.style.transition = 'all 0.5s ease';
                    setTimeout(function () {
                        alert.remove();
                    }, 500);
                }, 10000);
            });
        });
    </script>
    <script>
        // Enhance JobMonitor to show progress bar and persist across navigation
        class EnhancedJobMonitor extends JobMonitor {
            constructor(jobId, options = {}) {
                // Define UI update callbacks
                const onStatusChange = (job) => {
                    const progressFill = document.getElementById('job-progress-fill');
                    const statusText = document.getElementById('job-status-text');

                    if (progressFill) {
                        progressFill.style.width = job.progress + '%';
                    }

                    // Update status text based on function name
                    if (statusText) {
                        const jobLabels = {
                            'import_books': 'Importing books...',
                            'fetch_missing_data': 'Fetching covers & metadata...'
                        };
                        const label = jobLabels[job.function_name] || `Processing (${job.progress}%)`;
                        statusText.textContent = label;
                    }
                };

                const onComplete = (job) => {
                    console.log(`[EnhancedJobMonitor] Job completed:`, job);
                    if (job.result) {
                        const messagesContainer = document.querySelector('.messages');
                        if (messagesContainer) {
                            const alert = document.createElement('div');
                            alert.className = 'alert success';
                            alert.innerHTML = `<span>✨</span><span>${job.result}</span>`;
                            messagesContainer.appendChild(alert);

                            // Auto-hide after 5 seconds
                            setTimeout(function () {
                                alert.style.opacity = '0';
                                alert.style.transform = 'translateY(-10px)';
                                alert.style.transition = 'all 0.5s ease';
                                setTimeout(function () {
                                    alert.remove();
                                }, 500);
                            }, 10000);
                        }
                    }
                };

                const onError = (error) => {
                    const statusText = document.getElementById('job-status-text');
                    if (statusText) {
                        statusText.textContent = `Error: ${error}`;
                    }
                };

                // Pass callbacks to parent constructor
                super(jobId, {
                    ...options,
                    onStatusChange: onStatusChange,
                    onComplete: onComplete,
                    onError: onError
                });
            }

            start() {
                const indicator = document.getElementById('job-indicator');
                if (indicator) {
                    indicator.style.display = 'block';
                    indicator.style.marginTop = '0px';
                }

                super.start();
            }

            stop() {
                const indicator = document.getElementById('job-indicator');
                if (indicator) {
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 1500);
                }
                super.stop();
            }
        }

        // Check for new or active jobs on page load
        document.addEventListener("DOMContentLoaded", function () {
            let monitor = null;

            // First, check for a job_id in the URL (from form submission)
            const params = new URLSearchParams(window.location.search);
            const jobIdFromUrl = params.get("job_id");

            if (jobIdFromUrl) {
                console.log(`[JobMonitor] Found job_id in URL: ${jobIdFromUrl}`);
                monitor = new EnhancedJobMonitor(jobIdFromUrl);
                monitor.start();

                // Clean up URL by removing job_id parameter
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            } else {
                // Check if there's an active job in localStorage from a previous page
                const resumedBaseMonitor = JobMonitor.resumeActiveJob();
                if (resumedBaseMonitor) {
                    // Create an EnhancedJobMonitor instance with the same job ID
                    monitor = new EnhancedJobMonitor(resumedBaseMonitor.jobId, {
                        autoRefresh: false
                    });
                    monitor.start();
                }
            }

            // Store globally for manual interaction if needed
            if (monitor) {
                window.currentJobMonitor = monitor;
            }

            // Also check for data-job-id attribute on elements
            const jobElements = document.querySelectorAll("[data-job-id]");
            if (jobElements.length > 0 && !monitor) {
                jobElements.forEach((el) => {
                    const jobId = el.getAttribute("data-job-id");
                    console.log(`[JobMonitor] Found data-job-id: ${jobId}`);
                    const elementMonitor = new EnhancedJobMonitor(jobId);
                    elementMonitor.start();
                    window.currentJobMonitor = elementMonitor;
                });
            }
        });
    </script>

    <footer>
        &copy; {{ current_year }} Kelvin Chappell. Built with Python and Google Sheets.
    </footer>
</body>

</html>