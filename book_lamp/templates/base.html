<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Book Lamp{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    {% block head %}{% endblock %}
</head>

<body>
    <nav>
        <a href="/" class="logo">Book Lamp</a>
        <div class="nav-links" style="display: flex; align-items: center; gap: 1rem;">
            <a href="/books">Books</a>
            <a href="/history">History</a>
            <a href="/stats">Stats</a>
            <a href="/about">About</a>
            {% if not is_authorised %}
            <a href="/connect" class="btn" style="padding: 0.4rem 1rem; font-size: 0.8rem;">Authorise</a>
            {% endif %}

            <span id="connection-status" class="status-dot {{ 'connected' if is_authorised else 'disconnected' }}"
                title="{{ 'Google Sheets Connected (Click to Disconnect)' if is_authorised else 'Google Sheets Not Connected (Click to Authorise)' }}"
                data-authorised="{{ 'true' if is_authorised else 'false' }}" style="margin-left: 0.5rem;"
                onclick="toggleConnection()"></span>
        </div>
    </nav>

    <div class="container" style="padding-top: 1rem;">
        <div class="messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        {% block content %}{% endblock %}
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Confirm Delete</h2>
            <p id="modal-message">Are you sure you want to delete this?</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="btn">Confirm</button>
                <button onclick="closeModal()" class="btn btn-outline">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');

            // Remove old listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                closeModal();
            });

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('confirm-modal');
            if (event.target == modal) {
                closeModal();
            }
        }

        function submitPostRequest(urlStr) {
            try {
                var url = new URL(urlStr, window.location.origin);
                if ((url.protocol === 'http:' || url.protocol === 'https:') &&
                    url.origin === window.location.origin) {
                    var f = document.createElement('form');
                    f.method = 'POST';
                    f.action = url.toString();
                    document.body.appendChild(f);
                    f.submit();
                }
            } catch (e) {
                console.error('Failed to submit request:', e);
            }
        }

        function toggleConnection() {
            const statusDot = document.getElementById('connection-status');
            const isAuthorised = statusDot.getAttribute('data-authorised') === 'true';
            if (isAuthorised) {
                showConfirm(
                    'Disconnect Google Sheets',
                    'Are you sure you want to disconnect? You will need to re-authorise to access your data.',
                    () => { window.location.href = '/logout'; }
                );
            } else {
                showConfirm(
                    'Authorise Google Sheets',
                    'Would you like to authorise Google Sheets to store your reading data?',
                    () => { window.location.href = '/connect'; }
                );
            }
        }
    </script>

    <footer>
        &copy; 2026 Kelvin Chappell. Built with Python and Google Sheets.
    </footer>
</body>

</html>