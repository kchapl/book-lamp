{% extends "base.html" %}

{% block title %}Reading History - Book Lamp{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='history.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='books.css') }}">
{% endblock %}

{% block content %}
<div class="history-header">
    <h1>Reading History</h1>
</div>

<form class="history-controls" method="GET" action="{{ url_for('reading_history') }}">
    <div class="filter-group">
        <label for="status">Status:</label>
        <select name="status" id="status" onchange="this.form.submit()">
            <option value="">All Statuses</option>
            {% for status in statuses %}
            <option value="{{ status }}" {% if current_status==status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label for="min_rating">Min Rating:</label>
        <select name="min_rating" id="min_rating" onchange="this.form.submit()">
            <option value="">Any Rating</option>
            {% for r in range(1, 6) %}
            <option value="{{ r }}" {% if current_rating==r %}selected{% endif %}>{{ r }}+ Stars</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label for="sort">Sort By:</label>
        <select name="sort" id="sort" onchange="this.form.submit()">
            <option value="date_desc" {% if current_sort=='date_desc' %}selected{% endif %}>Most Recent</option>
            <option value="date_asc" {% if current_sort=='date_asc' %}selected{% endif %}>Oldest First</option>
            <option value="rating_desc" {% if current_sort=='rating_desc' %}selected{% endif %}>Highest Rating</option>
            <option value="title" {% if current_sort=='title' %}selected{% endif %}>Book Title</option>
        </select>
    </div>
</form>

<div class="history-list">
    {% if history %}
    {% for record in history %}
    <div class="history-book-card">
        <a href="{{ url_for('book_detail', book_id=record.book_id) }}" class="history-thumb">
            {% if record.book_thumbnail_url %}
            <img src="{{ record.book_thumbnail_url }}" alt="{{ record.book_title }}" loading="lazy" width="60"
                height="90">
            {% else %}
            <div class="no-cover">üìñ</div>
            {% endif %}
        </a>
        <div class="history-content">
            <h2 class="history-book-title">
                <a href="{{ url_for('book_detail', book_id=record.book_id) }}">{{ record.book_title }}</a>
            </h2>
            <div class="history-book-author">by
                {% if record.book_authors %}
                {% for author in record.book_authors %}
                <a href="{{ url_for('author_page', author_name=author) }}"
                    style="color: inherit; text-decoration: none; border-bottom: 1px dotted var(--primary-light); transition: color 0.2s;"
                    onmouseover="this.style.color='var(--primary-color)'" onmouseout="this.style.color='inherit'">{{
                    author }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
                {% else %}
                <a href="{{ url_for('author_page', author_name=record.book_author) }}"
                    style="color: inherit; text-decoration: none; border-bottom: 1px dotted var(--primary-light); transition: color 0.2s;"
                    onmouseover="this.style.color='var(--primary-color)'" onmouseout="this.style.color='inherit'">{{
                    record.book_author }}</a>
                {% endif %}
            </div>

            <div class="reading-event-list">
                <div class="reading-event" id="record-{{ record.id }}" data-edit-mode="false">
                    <form method="post" action="{{ url_for('update_reading_record', record_id=record.id) }}">
                        <!-- View Mode -->
                        <div class="view-only">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="status-badge status-{{ record.status | lower | replace(' ', '-') }}">
                                        {{ record.status }}
                                    </span>
                                    {% if record.rating > 0 %}
                                    <span class="stars">
                                        {% for _ in range(record.rating) %}‚òÖ{% endfor %}{% for _ in range(5 -
                                        record.rating) %}‚òÜ{%
                                        endfor %}
                                    </span>
                                    {% endif %}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="button" class="btn-icon" data-record-id="{{ record.id }}"
                                        onclick="setRecordEditMode(this.dataset.recordId, true)" title="Edit Record"
                                        aria-label="Edit Record">‚úèÔ∏è</button>
                                    <button type="button" class="btn-icon btn-icon-delete"
                                        data-record-id="{{ record.id }}"
                                        data-delete-url="{{ url_for('delete_reading_record', record_id=record.id) }}"
                                        onclick="deleteRecord(this.dataset.recordId, this.dataset.deleteUrl)"
                                        title="Delete Record" aria-label="Delete Record">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="event-dates" style="font-size: 0.85rem;">
                                {% if record.end_date %}
                                Completed: {{ record.end_date }}
                                {% elif record.start_date %}
                                Began: {{ record.start_date }}
                                {% endif %}
                                {% if record.status == 'Abandoned' and record.end_date %}
                                (Abandoned: {{ record.end_date }})
                                {% endif %}
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div class="edit-only edit-form-container">
                            <div class="edit-form-grid">
                                <div class="form-group edit-form-field">
                                    <label class="meta-label">Status</label>
                                    <select name="status" class="edit-input"
                                        onchange="updateRecordDateLabels('{{ record.id }}', this.value)" required>
                                        <option value="In Progress" {% if record.status=='In Progress' %}selected{%
                                            endif %}>In Progress</option>
                                        <option value="Completed" {% if record.status=='Completed' %}selected{% endif
                                            %}>Completed</option>
                                        <option value="Abandoned" {% if record.status=='Abandoned' %}selected{% endif
                                            %}>Abandoned</option>
                                    </select>
                                </div>
                                <div class="form-group edit-form-field">
                                    <label class="meta-label">Rating</label>
                                    <select name="rating" class="edit-input">
                                        <option value="0" {% if record.rating==0 %}selected{% endif %}>No Rating
                                        </option>
                                        <option value="1" {% if record.rating==1 %}selected{% endif %}>1 Star</option>
                                        <option value="2" {% if record.rating==2 %}selected{% endif %}>2 Stars</option>
                                        <option value="3" {% if record.rating==3 %}selected{% endif %}>3 Stars</option>
                                        <option value="4" {% if record.rating==4 %}selected{% endif %}>4 Stars</option>
                                        <option value="5" {% if record.rating==5 %}selected{% endif %}>5 Stars</option>
                                    </select>
                                </div>
                                <div class="form-group edit-form-field">
                                    <label class="meta-label">Start Date</label>
                                    <input type="date" name="start_date" class="edit-input"
                                        value="{{ record.start_date }}" required>
                                </div>
                                <div class="form-group edit-form-field {{ 'hidden' if record.status == 'In Progress' else '' }}"
                                    id="record-end-date-group-{{ record.id }}">
                                    <label id="record-end-date-label-{{ record.id }}" class="meta-label">
                                        {% if record.status == 'Completed' %}Completion Date{% elif record.status ==
                                        'Abandoned' %}Abandoned Date{% else %}End Date{% endif %}
                                    </label>
                                    <input type="date" name="end_date" class="edit-input"
                                        value="{{ record.end_date or '' }}" {% if record.status !='In Progress'
                                        %}required{% endif %}>
                                </div>
                            </div>
                            <div class="edit-form-actions">
                                <button type="submit" class="btn-save">Save</button>
                                <button type="button" class="btn-cancel"
                                    onclick="setRecordEditMode('{{ record.id }}', false)">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
        <h2>No history found</h2>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">No reading records match your current filters.</p>
        <a href="{{ url_for('list_books') }}" class="btn">Browse Bookshelf</a>
    </div>
    {% endif %}
</div>

<script>
    function setRecordEditMode(recordId, isEdit) {
        document.getElementById(`record-${recordId}`).setAttribute('data-edit-mode', isEdit);
    }

    function deleteRecord(recordId, deleteUrl) {
        showConfirm(
            'Delete Record',
            'Remove this reading record from your history?',
            () => submitPostRequest(deleteUrl)
        );
    }

    function updateRecordDateLabels(recordId, status) {
        const endGroup = document.getElementById(`record-end-date-group-${recordId}`);
        const endLabel = document.getElementById(`record-end-date-label-${recordId}`);
        const endInput = endGroup.querySelector('input');

        if (status === 'Completed') {
            endGroup.classList.remove('hidden');
            endLabel.textContent = 'Completion Date';
            endInput.required = true;
        } else if (status === 'Abandoned') {
            endGroup.classList.remove('hidden');
            endLabel.textContent = 'Abandoned Date';
            endInput.required = true;
        } else {
            endGroup.classList.add('hidden');
            endInput.required = false;
        }
    }
</script>
{% endblock %}